service: tech-journal-api
useDotenv: true

provider:
  name: aws
  runtime: nodejs20.x
  region: ${opt:region, 'ap-southeast-1'}
  memorySize: 256
  timeout: 29
  environment:
    NODE_ENV: production
    MONGODB_URI: ${env:MONGODB_URI}
    JWT_SECRET: ${env:JWT_SECRET}
    JWT_EXPIRES_IN: ${env:JWT_EXPIRES_IN, '86400'}
  httpApi:
    cors:
      allowedOrigins:
        - '*'
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS

functions:
  # ============ PUBLIC ENDPOINTS ============
  publicGetArticles:
    handler: src/functions/public/getArticles.handler
    events:
      - httpApi:
          path: /api/public/articles
          method: GET

  publicGetArticleBySlug:
    handler: src/functions/public/getArticleBySlug.handler
    events:
      - httpApi:
          path: /api/public/articles/{slug}
          method: GET

  publicGetTags:
    handler: src/functions/public/getTags.handler
    events:
      - httpApi:
          path: /api/public/tags
          method: GET

  publicGetSettings:
    handler: src/functions/public/getSettings.handler
    events:
      - httpApi:
          path: /api/public/settings
          method: GET

  # ============ AUTH ENDPOINTS ============
  authLogin:
    handler: src/functions/auth/login.handler
    events:
      - httpApi:
          path: /api/auth/login
          method: POST

  authLogout:
    handler: src/functions/auth/logout.handler
    events:
      - httpApi:
          path: /api/auth/logout
          method: POST

  authMe:
    handler: src/functions/auth/me.handler
    events:
      - httpApi:
          path: /api/auth/me
          method: GET

  # ============ ADMIN ARTICLES ============
  adminListArticles:
    handler: src/functions/admin/articles/list.handler
    events:
      - httpApi:
          path: /api/admin/articles
          method: GET

  adminGetArticle:
    handler: src/functions/admin/articles/get.handler
    events:
      - httpApi:
          path: /api/admin/articles/{id}
          method: GET

  adminCreateArticle:
    handler: src/functions/admin/articles/create.handler
    events:
      - httpApi:
          path: /api/admin/articles
          method: POST

  adminUpdateArticle:
    handler: src/functions/admin/articles/update.handler
    events:
      - httpApi:
          path: /api/admin/articles/{id}
          method: PUT

  adminDeleteArticle:
    handler: src/functions/admin/articles/delete.handler
    events:
      - httpApi:
          path: /api/admin/articles/{id}
          method: DELETE

  # ============ ADMIN TAGS ============
  adminListTags:
    handler: src/functions/admin/tags/list.handler
    events:
      - httpApi:
          path: /api/admin/tags
          method: GET

  adminCreateTag:
    handler: src/functions/admin/tags/create.handler
    events:
      - httpApi:
          path: /api/admin/tags
          method: POST

  adminUpdateTag:
    handler: src/functions/admin/tags/update.handler
    events:
      - httpApi:
          path: /api/admin/tags/{id}
          method: PUT

  adminDeleteTag:
    handler: src/functions/admin/tags/delete.handler
    events:
      - httpApi:
          path: /api/admin/tags/{id}
          method: DELETE

  # ============ ADMIN SETTINGS ============
  adminGetSettings:
    handler: src/functions/admin/settings/get.handler
    events:
      - httpApi:
          path: /api/admin/settings
          method: GET

  adminUpdateSettings:
    handler: src/functions/admin/settings/update.handler
    events:
      - httpApi:
          path: /api/admin/settings
          method: PUT

  # ============ AUDIT ============
  auditCreate:
    handler: src/functions/audit/create.handler
    events:
      - httpApi:
          path: /api/audit
          method: POST

  adminListAudit:
    handler: src/functions/admin/audit/list.handler
    events:
      - httpApi:
          path: /api/admin/audit
          method: GET

plugins:
  - serverless-esbuild
  - serverless-offline

custom:
  esbuild:
    bundle: true
    minify: true
    sourcemap: true
    platform: node
    format: esm
    target: node20
    outputFileExtension: .mjs
    banner:
      js: "import { createRequire } from 'module'; const require = createRequire(import.meta.url);"
  serverless-offline:
    httpPort: 3001
    noPrependStageInUrl: true
